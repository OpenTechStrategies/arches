Arches 8.0.0 Release Notes
--------------------------

### Major enhancements
- Adds editable_future_graphs and the ability to update Graphs without unpublishing. [#9613](https://github.com/archesproject/arches/issues/9613)
- Adds `ResourceInstanceLifecycle`s and `ResourceInstanceLifecycleState`s. [#11042](https://github.com/archesproject/arches/issues/11042)
- Removes RequireJS dependency. This reduces webpack bundle size and build time, and adds cache poisoning [#11902](https://github.com/archesproject/arches/issues/11902)
- Add token-based CSS theming [#11262](https://github.com/archesproject/arches/issues/11262)
- Support Python 3.13 [#11550](https://github.com/archesproject/arches/pull/11550)
- Support Django 5.2 [#11797](https://github.com/archesproject/arches/pull/11797)

### Performance improvements
- Improve indexing and bulk deletion performance [#11382](https://github.com/archesproject/arches/issues/11382)
- The following methods or functions in the permissions framework now take an optional ``resource`` keyword argument to avoid refetching an instance that a caller may already have:
    - `user_can_read_resource()`
    - `user_can_edit_resource()`
    - `user_can_delete_resource()`
    - `check_resource_instance_permissions()`
- Reduce queries in card API [#11534](https://github.com/archesproject/arches/pull/11534)
- Reduce queries in resource report view [#11637](https://github.com/archesproject/arches/pull/11637)

### Additional highlights
- Add session-based REST APIs for login, logout [#11261](https://github.com/archesproject/arches/issues/11261)
- Auth views now filter out passwords from error reports when running in production [#11652](https://github.com/archesproject/arches/issues/11652)
- Default setting for `LOGGING` now logs errors from web requests [#11812](https://github.com/archesproject/arches/issues/11812)
- Improve handling of longer model names [#11317](https://github.com/archesproject/arches/issues/11317)
- New column `NodeGroup.grouping_node`: one-to-one field to the grouping node [#11613](https://github.com/archesproject/arches/issues/11613)
- Support more expressive plugin URLs [#11320](https://github.com/archesproject/arches/issues/11320)
- Make node aliases not nullable [#10437](https://github.com/archesproject/arches/issues/10437)
- Add alt text on image placeholder [#10455](https://github.com/archesproject/arches/issues/10455)
- Tile functions no longer catch TypeError [#11805](https://github.com/archesproject/arches/issues/11805)
- Make failed login alert message dismissible [#11767](https://github.com/archesproject/arches/issues/11767)
- Concepts API no longer responds with empty body for error conditions [#11519](https://github.com/archesproject/arches/issues/11519)
- Restore support for `.create()` on Django model managers [#10958](https://github.com/archesproject/arches/issues/10958)
- Removes sample index from new projects, updates test coverage behavior [#11591](https://github.com/archesproject/arches/issues/11519)
- Fix HTTP return code for tile validation and cardinality errors [#11803](https://github.com/archesproject/arches/issues/11803)
- Fix spatial view regex validator message [#11849](https://github.com/archesproject/arches/issues/11849)
- Add system dark mode detection for Vue apps [#11624](https://github.com/archesproject/arches/issues/11624)
- Make number datatype node values searchable in the main search [#11619](https://github.com/archesproject/arches/issues/11619)
- Prevent navigation to a new browser tab when clicking Manage link in index.htm [#11635](https://github.com/archesproject/arches/issues/11635)
- Mitigate the tendency of JSON APIs to respond with HTML under error conditions [#11722](https://github.com/archesproject/arches/pull/11722)
- Add support for tile sort order to the bulk data manager [#11638](https://github.com/archesproject/arches/pull/11638)
- Show the loading UX immediately when the user imports a resource model [#10540](https://github.com/archesproject/arches/issues/10540)
- Fix issue that produced an error when cycling between the dropdown options in Advanced search [#11442](https://github.com/archesproject/arches/issues/11442)
- Add message when copying geojson url to clipboard [#11076](https://github.com/archesproject/arches/issues/11076)
- Hide "view report" button in Arches system settings [#11659](https://github.com/archesproject/arches/issues/11659)
- Updates github workflows postgis image to version 14-3.4 to match Arches core [#11833](https://github.com/archesproject/arches/issues/11833)
- Add validation error for geometry node used in spatial view attributes [#11888](https://github.com/archesproject/arches/issues/11888)
- Add source mapping to webpack development configuration [#11906](https://github.com/archesproject/arches/issues/11906)

### Dependency changes
```
Python:
    Upgraded:
        Django: 5.2b1
        celery: 5.4.0
        django-cors-headers: 4.7.0
        django-recaptcha: 4.0.0
        django-revproxy: 0.13.0
        django-webpack-loader: 3.1.1
        psycopg2: 2.9.10
        python-memcached: 1.62
        openpyxl: 3.1.5

    Added:

    Removed:
        tomli


JavaScript:
    Upgraded:
        primevue == 4.1.0

    Added:
        primeicons == 7.0.0

    Removed:
        regenerator-runtime 
        requirejs 
        requirejs-plugins
        requirejs-text

        (dev dependencies): 
            vue-template-compiler
```

### Breaking changes
- The minimum supported version of Python is now 3.11.

- The minimum supported version of GDAL is now 2.4 (along with GEOS 3.8).

- `TileModel.nodegroup` is no longer a foreign key. It can now store UUIDs referring to historical nodegroups that no longer exist. There is still a Django model field called `nodegroup` for expressing joins, but it is now nullable.

- Following a deprecation in 7.6.0, the `-o install` argument to `manage.py packages` has been removed.

- `ensure_userprofile_exists()` was removed from the `Tile` model.

- The following fields are no longer nullable. If you have custom SQL (or Python code that uses direct ORM operations to bypass model `save()`, etc.), you will need to set these fields directly on creation:
    - `Node.alias`
    - `TileModel.data`

- The following fields implemented [`related_name`](https://docs.djangoproject.com/en/stable/ref/models/fields/#django.db.models.ForeignKey.related_name) and [`related_query_name`](https://docs.djangoproject.com/en/stable/ref/models/fields/#django.db.models.ForeignKey.related_query_name) to improve upon the Django-supplied defaults:
    - `NodeGroup.parentnodegroup`
    - `TileModel.nodegroup`
    - `TileModel.parenttile`

    For instance, a tile query can prefetch its children with the more readable:
    ```
    TileModel.objects.filter(...).prefetch_related("children")
    ```

    Rather than:
    ```
    TileModel.objects.filter(...).prefetch_related("tilemodel_set")  # OLD NAME
    ```

    In the event you had ORM queries traversing the "reverse" side of these relationships,
    (i.e. from one to many), make these changes:

    - From NodeGroup, traversing a child nodegroup: `nodegroup` -> `child`
    - From NodeGroup, collecting child nodegroups: `nodegroup_set` -> `children`
    - From NodeGroup, traversing a tile: `tilemodel` -> `tile`
    - From NodeGroup, collecting all tiles: `tilemodel_set` -> `tiles`
    - From TileModel, traversing a child tile: `tilemodel` -> `child`
    - From TileModel, collecting child tiles: `tilemodel_set` -> `children`

- Tile cardinality errors raised when saving `TileModel` instances now raise `TileCardinalityError` rather than `ProgrammingError`.

- `TileValidationError` and `TileCardinalityError` now subclass `django.core.exceptions.ValidationError`.

- The format of JavaScript files has changed. Please refer to [Upgrading an Arches project](#upgrading-an-arches-project).
- The format of how some images are loaded in template files has changed. Please refer to [Upgrading an Arches project](#upgrading-an-arches-project).

### Upgrading Arches

1. You must be upgraded to at least version   before proceeding. If you are on an earlier version, please refer to the upgrade process in the []()

### Upgrading an Arches project

1. In pyproject.toml, make these updates:
    - Update `requires-python` to `">=3.11"`
    - Remove `"Programming Language :: Python :: 3.10"`
    - Add `"Programming Language :: Python :: 3.13"`
    - Remove `"Framework :: Django :: 4.2"`
    - Add `"Framework :: Django :: 5.2"`

1. Remove "3.10" from the `python-version` matrix in `.github/workflows/main.yml`.

1. In settings.py:
    - Add the following key to `DATABASES` to [potentially improve indexing performance](https://github.com/archesproject/arches/issues/11382):
    ```
        "OPTIONS": {
            "options": "-c cursor_tuple_fraction=1",
        },
    ```
    - Change the "captcha" entry in `INSTALLED_APPS` to reflect its new name:
    ```
    INSTALLED_APPS = [
        ...
        "django_recaptcha",  # was "captcha"
        ...
    ]
    ```
    - In `LOGGING`, replace `"loggers"` with the following to begin logging failed web requests:
    ```
        "loggers": {
            "arches": {
                "handlers": ["file", "console"],
                "level": "WARNING",
                "propagate": True,
            },
            "django.request": {
                "handlers": ["file", "console"],
                "level": "WARNING",  # or consider ERROR if this is too noisy
                "propagate": True,
            },
            # consider adding your own project here if it logs
        },
    ```
    - Remove `OVERRIDE_RESOURCE_MODEL_LOCK` if present.

1. Update your frontend dependencies:
    ```
    rm -rf node_modules package-lock.json
    npm install
    ```

1. Within your project, with your Python 3 virtual environment activated run:
    ``` 
    python manage.py migrate
    ```

1. Then run:
    ```
    python manage.py updateproject
    ```

1. Update your urls.py to include generic error handlers:

    ```
    handler400 = "arches.app.views.main.custom_400"
    handler403 = "arches.app.views.main.custom_403"
    handler404 = "arches.app.views.main.custom_404"
    handler500 = "arches.app.views.main.custom_500"
    ```

1. Create editable_future_graphs for your Resource Models:
    ```
    python manage.py graph create_editable_future_graphs
    ``` 
    
    This will publish new versions of each Graph.

1. Update your Graph publications and Resource instances to point to the newly published Graphs:
    ```
    python manage.py graph publish --update -ui
    ```

1. Also consider running validation checks:
    ```
    python manage.py validate
    python manage.py validate --fix [error]
    ```

1. Within your project with your Python 3 virtual environment activated:
    ```
    python manage.py es reindex_database
    ```

1. Update your project's `package.json`:
    - Remove any references to `NODE_OPTIONS` and `NODE_ENV`
    ```json
    <!-- defunct format -->

    "scripts": {
        "build_development": "npm run eslint:check && npm run ts:check && cross-env NODE_OPTIONS=--max-old-space-size=2048 webpack --config ./webpack/webpack.config.dev.js",
        "build_production": "npm run eslint:check && npm run ts:check && cross-env NODE_OPTIONS=--max-old-space-size=2048 NODE_ENV=production webpack --config ./webpack/webpack.config.prod.js",
        "build_test": "npm run eslint:check && npm run ts:check && cross-env NODE_OPTIONS=--max-old-space-size=2048 webpack --config ./webpack/webpack.config.dev.js --env test=true",
        ...
        "start": "cross-env NODE_OPTIONS=--max-old-space-size=2048 webpack serve --config ./webpack/webpack.config.dev.js",
    },
    ```

    ```json
    <!-- updated format -->

    "scripts": {
        "build_development": "npm run eslint:check && npm run ts:check && cross-env webpack --config ./webpack/webpack.config.dev.js",
        "build_production": "npm run eslint:check && npm run ts:check && cross-env webpack --config ./webpack/webpack.config.prod.js",
        "build_test": "npm run eslint:check && npm run ts:check && cross-env webpack --config ./webpack/webpack.config.dev.js --env test=true",
        ...
        "start": "cross-env webpack serve --config ./webpack/webpack.config.dev.js",
    },
    ```

1. Update the JavaScript files in your project:
    1. Update the import and export logic. 
        - Imports should follow the typical ES6 import pattern
        - Anything `return`-ed from a RequireJS function should be the default export of the file.

        ```js
        // defunct format

        define([
            'knockout', 
            'viewmodels/report', 
            'templates/views/report-templates/default.htm',
        ], function(ko, ReportViewModel, defaultReportTemplate) {
            return ko.components.register('default-report', {
                viewModel: function (params) {
                    params.configKeys = [];
                    ReportViewModel.apply(this, [params]);
                },
                template: defaultReportTemplate
            });
        });

        ```
        ```js
        // updated format

        import ko from 'knockout';
        import ReportViewModel from 'viewmodels/report';
        import defaultReportTemplate from 'templates/views/report-templates/default.htm';

        export default ko.components.register('default-report', {
            viewModel: function (params) {
                params.configKeys = [];
                ReportViewModel.apply(this, [params]);
            },
            template: defaultReportTemplate
        });
        ```

    1. If you have created a custom knockout binding, you must bind any declared functions to the object.
        ```js
        // defunct format

        define([
            'knockout',
        ], function(ko) {
            ko.bindingHandlers.hover = {
                init: function(element, valueAccessor) {
                    var value = valueAccessor();
                    ko.applyBindingsToNode(element, {
                        event: {
                            mouseenter: function() { value(true); },
                            mouseleave: function() { value(false); }
                        }
                    });
                }
            };
            return ko.bindingHandlers.hover;
        });

        ```

        ```js
        // updated format

        import ko from 'knockout';

        ko.bindingHandlers.hover = {
            init: function(element, valueAccessor) {
                var value = valueAccessor();
                ko.applyBindingsToNode(element, {
                    event: {
                        mouseenter: function() { value(true); },
                        mouseleave: function() { value(false); }
                    }
                });
            }
        };
        ko.bindingHandlers.hover.init = ko.bindingHandlers.hover.init.bind(ko.bindingHandlers.hover);

        export default ko.bindingHandlers.hover;

        ```

    1. If you are importing in the body of your JavaScript components, those imports should be moved to the top.
        ```js
        // defunct format

        define([
            'jquery',
            'underscore',
            'knockout',
            'arches',
            'report-templates',
            'models/report',
            'models/graph',
            'viewmodels/alert',
            'templates/views/components/resource-report-abstract.htm',
            'viewmodels/card',
        ], function($, _, ko, arches, reportLookup, ReportModel, GraphModel, AlertViewmodel, resourceReportAbstractTemplate) {
            var ResourceReportAbstract = function(params) {
                var self = this; 
                var CardViewModel = require('viewmodels/card');
                ...
        ```

        ```js
        // updated format

        import $ from 'jquery';
        import _ from 'underscore';
        import ko from 'knockout';
        import arches from 'arches';
        import reportLookup from 'report-templates';
        import ReportModel from 'models/report';
        import GraphModel from 'models/graph';
        import AlertViewmodel from 'viewmodels/alert';
        import resourceReportAbstractTemplate from 'templates/views/components/resource-report-abstract.htm';
        import CardViewModel from 'viewmodels/card';


        var ResourceReportAbstract = function(params) {
            var self = this;
            ...
        ```

1. Update the templates in your project:
    - Any interpolation of `STATIC_URL` should be replaced with `webpack_static`

    ```html
    <!-- defunct format -->

    <img id="map-buffer-search-help-gif" src="{{ STATIC_URL }}img/help/map-buffer-search.gif" aria-hidden="true"></img>
    ```
    ```html
    <!-- updated format -->

    <img id="map-buffer-search-help-gif" src="{% webpack_static 'img/help/map-buffer-search.gif' %}" aria-hidden="true"></img>
    ```

1. Rebuild your static asset bundle:
    - Ensure your Python 3 virtual environment activated

    - If running your project in development:
        - Option 1: Development Mode (Live Rebuilding)
            ```
            npm start
            ```
            This will build the frontend of the application and then start a webpack development server. The webpack development server will automatically detect changes to bundled assets and rebuild the static asset bundle. This process should take less than 30 seconds.

        - Option 2: Development Build with Checks
            ```
            npm run build_development
            ```
            This will run ESLint and TypeScript checks, then build the static asset bundle. This process should take less than 30 seconds.

    - If running your project in production:
        ```
        npm run build_production
        ```
        This will build a minimized, production-ready static asset bundle. This process should take less than 5 minutes.

1. Collect static files (optional):
    ```
    python manage.py collectstatic
    ```

    This will gather all static files (CSS, JavaScript, Vue, images, etc) and copy them into your projects `STATIC_ROOT` directory. This step does not need to be done if developing locally.

